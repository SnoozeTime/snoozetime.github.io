<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Post about my interests. Might include stuff about coding, reading, traveling or boxing">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Snoozetime's webpage</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#400000">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://snoozetime.github.io/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/ethereum-virtual-machine-in-rust-part-1/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="http://snoozetime.github.io/">

            <span id="blog-title">Snoozetime's webpage</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="#" class="nav-link">Home</a>
                </li>
<li class="nav-item">
<a href="archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/ethereum-virtual-machine-in-rust-part-1/" class="u-url">Ethereum Virtual Machine in Rust - Part 1</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Snoozetime
                    </span></p>
            <p class="dateline">
            <a href="posts/ethereum-virtual-machine-in-rust-part-1/" rel="bookmark">
            <time class="published dt-published" datetime="2018-11-09T13:54:50+09:00" itemprop="datePublished" title="2018-11-09 13:54">2018-11-09 13:54</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/ethereum-virtual-machine-in-rust-part-1/#disqus_thread" data-disqus-identifier="cache/posts/ethereum-virtual-machine-in-rust-part-1.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>Welcome to the great series - if everything goes well - about the Ethereum Virtual machine.
Lately I have been growing fond of emulation and cryptocurrency so I decided to take a look
at the inside of Ethereum: the virtual machine that is executing smart contracts.</p>
<p>And while implementing a fake EVM (Ethereum Virtual Machine) can be a challenge, why not do
it in a language I have absolutely no experience in. After these few lines, I realize the
probabilities I finish this serie of blog post is meager at best.</p>
<p>Anyway let's get started. In this first part I'll talk about compiling a solidity contract
to binary file, and creating a small program to read each instruction.</p>
<h3>Our Amazing smart contract</h3>
<p>Take a look at this beauty.</p>
<pre class="code literal-block"><span></span>pragma solidity ^0.4.0;

contract Addition{

    int public x;

    function add(int a, int b) public {
        x = a + b;
    }
}
</pre>


<p>It's not doing much. Anybody can call <code>add</code> which will just store the addition of its
argument in the ledger. Then anybody can read the value.</p>
<p>Then, run <code>solc --bin-runtime --optimize -o . contract.sol</code> to output the compiled contract  binary code to the current directory.</p>
<p>On my computer, I get:</p>
<blockquote>
<p>608060405260043610603e5763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663a5f3c23b81146043575b600080fd5b348015604e57600080fd5b50605b600435602435605d565b005b016000555600a165627a7a723058204ff1427599e28990ab2413948c03501a48ab89d18888ac7d0205c12f443424070029</p>
</blockquote>
<p>By the way, this is an hexadecimal string. This is going to be important when we read it from Rust (https://solidity.readthedocs.io/en/v0.4.21/using-the-compiler.html)</p>
<h3>Reading the binary file</h3>
<p>Rust makes it quite easy to read data from a file.</p>
<pre class="code literal-block"><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">run</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"myfilename"</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">run</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>


<p>This is going to print the content of our file. Right now, the whole code is loaded in the
string. There might be better way to do it but ultimately the code is always loaded in the RAM
of the EVM. Also, the smart contracts tend to be small so it should be no problem to do it like
that.</p>
<h3>Opcode and Virtual machine execution</h3>
<p>A virtual machine, such as the Java Virtual Machine, will take a set of instructions and execute
them. in Java the set of instruction is in the Java bytecode (https://en.wikipedia.org/wiki/Java_bytecode). In Ethereum, the set of instruction is the content of the binary file we just read. The instruction set is described in the Ethereum Yellow paper, in the appendix. https://ethereum.github.io/yellowpaper/paper.pdf</p>
<p>For example, the value 0x30 corresponds to the ADDRESS instruction (or opcode) and tells the
ethereum VM to get the address of currently executed account. Let's not worry about all the technical terms for now. Just keep in mind that our binary file is a set of instructions, and
each instructions are 8 bits, or 1 byte, long.</p>
<p>Our file content is an hexadecimal string, so we can represent the first bytes as:
<em>0x60</em> <em>0x80</em> <em>0x60</em> <em>0x40</em> <em>0x52</em>
If you look at the specifications, you can convert to a more readable format:
- PUSH one byte to stack: 0x80
- PUSH one byte to stack: 0x40
- STORE one word to memory</p>
<p>Next step in our program is to convert our string to a list of bytes (<code>u8</code> in Rust).</p>
<pre class="code literal-block"><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">num</span>::<span class="n">ParseIntError</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">decode</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseIntError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">0</span><span class="p">..(</span><span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">step_by</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="kt">u8</span>::<span class="n">from_str_radix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">..</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">16</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>


<p>It will construct a vector of bytes. Function composition here makes the code very expressive:
- We get an iterator from 0 to the length of our string (excluded)
- We get another iterator that will yield the first iterator elements with a step of 2. (Yield 0, 2, 4, 6... and so on)
- Then, for each index, we apply <code>u8::from_str_radix</code> to the slice [i..i+2] of our input string. This is going to convert the string to a <code>u8</code> integer, base 16. This can panic in case the string does not represent a valid integer base 16 ('P0' would panic)
- We consume the iterators with collect.</p>
<p>Iterators are lazy in Rust, so we need to call collect at the end to consume them. See here for more details: https://doc.rust-lang.org/book/second-edition/ch13-02-iterators.html</p>
<p>The Result trait implements FromIter, so instead of returning <code>Vec&lt;Result&lt;u8, ParseIntError&gt;&gt;</code>, we can return <code>Result&lt;Vec&lt;u8&gt;, ParseIntError&gt;</code>. See also here https://doc.rust-lang.org/std/result/enum.Result.html#method.from_iter</p>
<p>Now we can print our bytes from the files.</p>
<pre class="code literal-block"><span></span><span class="k">fn</span> <span class="nf">run</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"myfilename"</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bytes</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"0x{:x}"</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>


<h3>Our simple EVM</h3>
<p>Now that we can read the bytes of our compiled smart contract, let's start the implementation
of the VM. I am just going to show how to print debug information about the instructions in this
part. We are going to iterate over the list of instructions and print what they mean. No stack
or memory involved here :)</p>
<p>The most basic VM will hold the code in memory, and will iterate through it. We could use range-based loop to do the iteration, but you will see later that it won't work nicely with our use case.
For example, not all instructions are only one byte long. Some, such as PUSH3, are 4 bytes long (one byte for the instruction value, and 3 bytes for the value to push to the stack).</p>
<p>For that reason, I am going to keep an index of the current instruction in the code vector. This index is often called pc, for program counter.</p>
<pre class="code literal-block"><span></span><span class="k">struct</span> <span class="nc">Vm</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">code</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// smart contract code</span>
<span class="w">    </span><span class="n">pc</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="c1">// current instruction</span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Vm</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new_from_file</span><span class="p">(</span><span class="n">filename</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Vm</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">f</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Vm</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">code</span>: <span class="nc">code</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span>: <span class="mi">0</span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>


<p><code>new_from_file</code> will initialize us a new VM. Then, we need a way to model the instruction. I found enumeration in Rust well suited for this as they are very flexible. I also really like
the pattern matching with enumerations.</p>
<p>Let's get started. There are more than an hundred instructions in the EVM instruction set so
I'll just show a few of them.</p>
<pre class="code literal-block"><span></span><span class="k">enum</span> <span class="nc">Opcode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">STOP</span><span class="p">,</span><span class="w"> </span><span class="c1">// 0x00</span>
<span class="w">    </span><span class="n">ADD</span><span class="p">,</span><span class="w"> </span><span class="c1">// 0x01</span>
<span class="w">    </span><span class="n">MUL</span><span class="p">,</span><span class="w"> </span><span class="c1">// 0x02</span>

<span class="w">    </span><span class="n">PUSH1</span><span class="p">(</span><span class="kt">u8</span><span class="p">),</span><span class="w"> </span><span class="c1">// 0x60</span>
<span class="w">    </span><span class="n">PUSH2</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">),</span><span class="w"> </span><span class="c1">// 0x61</span>

<span class="w">    </span><span class="n">PUSH32</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">),</span><span class="w"> </span><span class="c1">// 0x7f </span>
<span class="p">}</span><span class="w"></span>
</pre>


<p><code>PUSH1(u8)</code> means that the instruction is made of 2 bytes. First byte is the instruction value, 
second byte is the value to push to the stack. We are going to store this value in the enumeration.</p>
<p>Now that we have our Opcode enumeration, we need to yield opcodes from the list of bytes. This is called decoding. The <code>next</code> function will return the Opcode at the current pc, and then advance pc to the next instruction.</p>
<pre class="code literal-block"><span></span><span class="k">impl</span><span class="w"> </span><span class="n">Vm</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Opcode</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="mh">0x00</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">STOP</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="mh">0x01</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">ADD</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="mh">0x02</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">MUL</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="mh">0x60</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">PUSH1</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Ox61</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">value0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">value1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">PUSH2</span><span class="p">(</span><span class="n">value0</span><span class="p">,</span><span class="w"> </span><span class="n">value1</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nb">None</span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>


<p>Right now, I ignore the error cases (for example, buffer overflow). Rust will panic if I try to
access values with indexes that are larger that the size of the vector. Also, the code is a bit
repetitive so there might be a better way to do it.</p>
<p>What <code>next</code> is doing is basic, but at the heart of the instruction decoding:
- Get the current byte
- Match it with an opcode
- If the opcode needs additional data from the instruction vector, extract them
- Move pc to the next instruction
- Return Opcode if found</p>
<p>For the <code>PUSH</code> instructions, pc is incremented multiple times.</p>
<h3>Peeking inside the code</h3>
<p><code>next</code> will give us the next instruction to execute. For now, I am just going to print it to
the console without extra logic. This will be useful in the future to debug our code. </p>
<p>The easiest way is to make our enum derive from <code>Debug</code>. Then we'll be able to print the enum
name with <code>println!</code>.</p>
<pre class="code literal-block"><span></span><span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">Opcode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">run</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="p">...</span><span class="w"></span>

<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">vm</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>


<p>Just by doing so, I have the following output.</p>
<blockquote>
<p>ADD
PUSH1(0)
STOP
MUL
STOP
thread 'main' panicked at 'index out of bounds: the len is 143 but the index is 143', libcore/slice/mod.rs:2046:10</p>
</blockquote>
<p>This is good, but we can do much better. First, just display the enumeration name and content does not give enough information. I'd like a description of the opcode and the address of the opcode in the binary. Second, this panic should not be there, as our program executed as expected.</p>
<p>To avoid the panic, I'll add a secret Opcode (sshh) that signifies our program ends. We could break on None in the loop but I still want to intepret the whole code even if there are codes I
haven't implemented yet. So let's add <code>EOF</code> to our Opcode enumeration. In reality, 0x00 will
take care of that.</p>
<p>Before the match in <code>next</code>:</p>
<pre class="code literal-block"><span></span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">EOF</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</pre>


<p>And in the match of the main loop:</p>
<pre class="code literal-block"><span></span><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">vm</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">EOF</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">break</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre>


<p>Happy days!</p>
<p>At last, I want to print more information. so let's add the instruction number and the description for each enum.</p>
<pre class="code literal-block"><span></span><span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">Opcode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">STOP</span><span class="p">(</span><span class="kt">usize</span><span class="p">),</span><span class="w"> </span><span class="c1">// 0x00</span>
<span class="w">    </span><span class="n">ADD</span><span class="p">(</span><span class="kt">usize</span><span class="p">),</span><span class="w"> </span><span class="c1">// 0x01</span>
<span class="w">    </span><span class="n">MUL</span><span class="p">(</span><span class="kt">usize</span><span class="p">),</span><span class="w"> </span><span class="c1">// 0x02</span>

<span class="w">    </span><span class="n">PUSH1</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">),</span><span class="w"> </span><span class="c1">// 0x60</span>
<span class="w">    </span><span class="n">PUSH2</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">),</span><span class="w"> </span><span class="c1">// 0x61</span>
<span class="w">    </span><span class="n">PUSH32</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">),</span><span class="w"> </span><span class="c1">// 0x7f </span>

<span class="w">    </span><span class="n">EOF</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>


<p>And next will become:</p>
<pre class="code literal-block"><span></span><span class="w">    </span><span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Opcode</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">EOF</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">             </span><span class="mh">0x00</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">STOP</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="mh">0x01</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">ADD</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="mh">0x02</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">MUL</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="mh">0x60</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">PUSH1</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="mh">0x61</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">value0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">value1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">code</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">PUSH2</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">value0</span><span class="p">,</span><span class="w"> </span><span class="n">value1</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">pc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="nb">None</span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre>


<p>Now we can create a function that will describe the opcode.</p>
<pre class="code literal-block"><span></span><span class="k">impl</span><span class="w"> </span><span class="n">Opcode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">describe</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Opcode</span>::<span class="n">STOP</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"0x{:x}</span><span class="se">\t</span><span class="s">STOP</span><span class="se">\t</span><span class="s">Halts execution"</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">Opcode</span>::<span class="n">ADD</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"0x{:x}</span><span class="se">\t</span><span class="s">ADD</span><span class="se">\t</span><span class="s">Addition operation"</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">Opcode</span>::<span class="n">MUL</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"0x{:x}</span><span class="se">\t</span><span class="s">MUL</span><span class="se">\t</span><span class="s">Multiplication operation"</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">Opcode</span>::<span class="n">PUSH1</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"0x{:x}</span><span class="se">\t</span><span class="s">PUSH1</span><span class="se">\t</span><span class="s">Place 1-byte item on the stack 0x{:x}"</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">Opcode</span>::<span class="n">PUSH2</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"0x{:x}</span><span class="se">\t</span><span class="s">PUSH2</span><span class="se">\t</span><span class="s">Place 2-bytes item on the stack 0x{:x} 0x{:x}"</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Unknown opcode"</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="c1">// update run function</span>
<span class="k">fn</span> <span class="nf">run</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Addition.bin-runtime"</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"In file {}"</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vm</span>::<span class="n">new_from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">filename</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">vm</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">Opcode</span>::<span class="n">EOF</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">break</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">describe</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>


<h3>A final word</h3>
<p>I showed in this article how to create a tool to display the instructions from an ethereum smart contract binary. It is not complete: the <code>describe</code> and <code>next</code> method have to be populated with all the opcodes in order to be complete.</p>
<p>In the next article I will introduce the memory layout of the EVM. We'll talk about concepts such as stack, memory and persistent storage.</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/slug/" class="u-url">Bezier curve in Unity: Bounding boxes</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Snoozetime
                    </span></p>
            <p class="dateline">
            <a href="posts/slug/" rel="bookmark">
            <time class="published dt-published" datetime="2018-05-22T00:00:00+09:00" itemprop="datePublished" title="2018-05-22 00:00">2018-05-22 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/slug/#disqus_thread" data-disqus-identifier="cache/posts/bezier-curve-bounding-box.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div class="figure">
<p><img src="images/micromachine.jpg" alt="micromachine.jpg"></p>
</div>

<p>
Instead of the common FPS/RPG/Platformer, for some reason I decide to create a clone of the old micromachine,
in particular the elimination mode when players are eliminated when they are too far away from the first player.
</p>

<p>
As the game was creating itself in my head, I stumbled against a mathematical obstacle in the first week
of prototyping. How to determine which player is the first? How to determinate what path the AI should
follow.
</p>

<p>
It turns out that part of the answer is to represent tracks as a curve, and Bezier curves are used in a bunch of
applications from photoshop to font creation. To find out what player is first, I would just have
to calculate the position of all pilots on the tracks.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Some reading before getting started</h2>
<div class="outline-text-2" id="text-1">
<p>
This article will be introducing a bit a linear algebra. In particular, we will apply translation and
rotation to our vectors. Also, we need to find the roots of a quadratic equation. The maths are not
too complicated but feel free to read the following links beforehand:
</p>
<ul class="org-ul">
<li>
<a href="https://en.wikipedia.org/wiki/Quadratic_equation">Wikipedia article on finding the roots of a quadratic formula</a>
</li>
<li>
<a href="http://planning.cs.uiuc.edu/node97.html">Description of translation, rotation and their combinaison</a>
</li>
</ul>
<p>
This article builds on an existing article which can be found here: <a href="https://catlikecoding.com/unity/tutorials/curves-and-splines/">https://catlikecoding.com/unity/tutorials/curves-and-splines/</a>
It shows how to implement a Bezier curve in Unity, showing at the same time how editor scripts work.
</p>

<p>
The last resource is an ebook called "A primer on Bezier". It can be found <a href="https://pomax.github.io/bezierinfo/">here.</a>
This ebook contains all you need to know about Bezier curves, theory and pseudocode included.
</p>


<div class="figure">
<p><img src="images/bezier_initial.png" alt="bezier_initial.png"></p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Bounding box</h2>
<div class="outline-text-2" id="text-2">
<p>
Bounding box are useful. In my use case, I want to find the closest point to the spline so bounding boxes
will help determine what bezier curve I should select to do the calculation!
</p>

<p>
The way to find the bounding box is to get the minimim/maximum along the x and y axis and create the boxes
from (x<sub>min</sub>, y<sub>min</sub>), (x<sub>min</sub>, y<sub>max</sub>), (x<sub>max</sub>, y<sub>min</sub>), (x<sub>max</sub>, y<sub>max</sub>).
</p>

<p>
However, this has the tendency to create large bounding boxes so we can get tighter boxes by aligning them
along our curve. (<a href="https://pomax.github.io/bezierinfo/#boundingbox">Part 17 - Bounding box</a>)
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Beforehand, define the curve</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Curve is such as
</p>
\begin{equation}
B(t) = (1-t)^3P_0 + 3(1-t)^2tP_1 + 3(1-t)t^2P_2 + t^3P_3
\end{equation}

<p>
where \(P_0, P_1, P_2, P_3\) are the control points of the curve, in global coordinates.
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Align the curve on an axis.</h3>
<div class="outline-text-3" id="text-2-2">
<p>
To align the curve, we first need to apply a translation T to the first point of the curve in order to place it
on the origin (0, 0). We have \(T = -P_0\).
</p>

zsh:1: command not found: pygmentize

<p>
Then, we need to apply the rotation so that \(P_3\) is on the x-axis. Given x and y the coordinates of \(P_3\), x' and y'
the coordinates after rotation \(\theta\), we have the equations:
</p>

\begin{equation}
x' = xcos(theta) - ysin(theta)

y' = ycos(theta) + x sin(theta)
\end{equation}

<p>
<a href="https://www.siggraph.org/education/materials/HyperGraph/modeling/mod_tran/2drota.htm">Don't take my word for granted :)</a>
</p>

zsh:1: command not found: pygmentize

<p>
We find theta such as \(y' = 0\).
</p>
\begin{equation}
\theta = atan(-y/x)
\end{equation}

zsh:1: command not found: pygmentize

<p>
Just for fun, let's draw the Bezier curve after rotation.
</p>

zsh:1: command not found: pygmentize

<p>
When adding the aligned curve to the editor script, we get the following.
</p>


<div class="figure">
<p><img src="images/aligned_bezier.png" alt="aligned_bezier.png"></p>
</div>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">Find the bounding box for the aligned curve</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Once we have our aligned curve, we need to find its bounding box. To do so, we need to calculate the roots of the
curve for x and y in order to get the minimum and maximum on the axis for t between 0 and 1.
</p>

<p>
To get an idea about why we want the minimum and maximum of a curve, please refer to my amazing drawing.
<img src="images/bounding_box.png" alt="bounding_box.png"></p>

<p>
In this piece of art, the maximum and minimum of y are located on the curve. For x however, only the
minimum x is located on the curve. The maximum is one of our control point. This is why we absolutely
have to include the first and last control points when we want to find the minimum and maximum on each
axis.
</p>

<p>
For a quadratic or cubic Bezier curve, it is very easy to find the minimum and maximum for each axis.
The way to do it is to calculate the derivate of the curve, and find the t values for which this
derivative is 0. These values are called the roots of the curve for the x or y axis. The Wikipedia
article at the top of the blog article explains it more deeply.
</p>

<p>
After deriving the Bezier equation and simplifying it a bit, we obtain:
</p>
\begin{equation}
3 (-x_{p_0} + 3x_{p_1} - 3x_{p_2} + x_{p_3})t^2 + 6(x_{p_0} - 2x_{p_1} + x_{p_2})t + 3(x_{p_1} - x_{p_0}) = 0
\end{equation}

<p>
Where \(x_{p_i}\) is the x coordinate of the point i. There is the same equation for y. Now that
we have reduce our equation to a simple quadratic equation, the solution is textbook.
</p>

\begin{equation}
a = 3(-x_{p_0} + 3x_{p_1} - 3x_{p_2} + x_{p_3})
\end{equation}

\begin{equation}
b = 6(x_{p_0} - 2x_{p_1} + x_{p_2})
\end{equation}

\begin{equation}
c = 3(x_{p_1} - x_{p_0})
\end{equation}

\begin{equation}
\Delta = b^2 - 4 ac
\end{equation}

<p>
\(\Delta\) (Delta) is the discriminant. We can find imaginary roots (that cannot be represented in our
2D space) when delta is negative, so here we are just interested about the real roots, meaning when
\(\Delta &gt;= 0\).
</p>

<p>
The two roots (which can be only one is the discriminant is 0) for the axis x are:
</p>

\begin{equation}
t_1 = \frac{-b - \sqrt{\Delta}}{4ac}
\end{equation}

\begin{equation}
t_2 = \frac{-b + \sqrt{\Delta}}{4ac}
\end{equation}

<p>
Notice that when \(\Delta\) is 0, \(t_1\) and \(t_2\) are the same. For our Bezier curve, we only care about
parameter between 0 and 1 so the roots might not be usable. In C#, there is not much complexity. Just
write down the last equations and filter the values.
</p>

zsh:1: command not found: pygmentize
<p>
(You can even refactor this to do the calculation once! When reading back this code I noticed that
I was a bit lazy here).
</p>


<p>
Now, our minimum and maximum along x and y would be one of the point that has a parameter t, where t
is either a root, 0 or 1.
</p>

zsh:1: command not found: pygmentize

<p>
We have our \(x_min\), \(x_max\), \(y_min\), \(y_max\). This is all we need for drawing the bounding box.
</p>



<div class="figure">
<p><img src="images/bounding_box_aligned.png" alt="bounding_box_aligned.png"></p>
</div>
</div>
</div>



<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">Rotate the box back</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Almost there! At this point, we have the bounding box of the aligned curve. To get the aligned curve,
we applied two transformations to our Bezier curve: first a translation, then a rotation. To get back
to the original curve, you can simply do the inverse! First, rotate the aligned curve by the opposite
of the first rotation (\(-\theta\)), then translate it by the opposite of the first translation (\(-P_0\)).
</p>

<p>
We can do the same with the bounding box, and it should fit our original Bezier curve!
</p>

<p>
With the previous minima and maxima:
</p>
zsh:1: command not found: pygmentize

<p>
Which gives us, at last:
</p>


<div class="figure">
<p><img src="images/bounding_box_final.png" alt="bounding_box_final.png"></p>
</div>
</div>
</div>
</div>



<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">What's next?</h2>
<div class="outline-text-2" id="text-3">
<p>
All this to find the bounding boxes of each curve in our Bezier spline! While it looks like a lot of work,
these bounding boxes are really going to help us find the projection of a point on the spline.
</p>

<p>
Instead of having to consider all the spline, now we can just reduce the problem to a list of Bezier curves.
Calculating distance to a box is pretty simple, so we just need to find the closest boxes to our point and
for each curve, finding the closest point. This will be done by an iterative approach (mathematical approach
is out of the question here - spoiler alert), so keep tuned for the next article.
</p>
</div>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/random-pictures-in-japan-1/" class="u-url">Random pictures in Japan 1</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Snoozetime
                    </span></p>
            <p class="dateline">
            <a href="posts/random-pictures-in-japan-1/" rel="bookmark">
            <time class="published dt-published" datetime="2018-05-03T22:56:55+09:00" itemprop="datePublished" title="2018-05-03 22:56">2018-05-03 22:56</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/random-pictures-in-japan-1/#disqus_thread" data-disqus-identifier="cache/posts/random-pictures-in-japan-1.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div class="figure">
<p><img src="images/monkey.jpg" alt="monkey.jpg"></p>
<p><span class="figure-number">Figure 1:</span> A dude chilling with his monkey</p>
</div>



<div class="figure">
<p><img src="images/konniaku.jpg" alt="konniaku.jpg"></p>
<p><span class="figure-number">Figure 2:</span> An overly dramatic caption</p>
</div>



<div class="figure">
<p><img src="images/cupnoodle.jpg" alt="cupnoodle.jpg"></p>
<p><span class="figure-number">Figure 3:</span> Preschool fun at the CupNoodle museum in Minato Mirai</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/code-generation-python/" class="u-url">Code generation with Python - How learning Python can save you a bunch of time</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Snoozetime
                    </span></p>
            <p class="dateline">
            <a href="posts/code-generation-python/" rel="bookmark">
            <time class="published dt-published" datetime="2018-05-02T00:00:00+09:00" itemprop="datePublished" title="2018-05-02 00:00">2018-05-02 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/code-generation-python/#disqus_thread" data-disqus-identifier="cache/posts/code_generation_with_python.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <p>
More often than not, working in a IT project requires a lot of repetitive
tasks. In particular, one area that can be very debilitating is the creation
of test data. We know it is indispensable to the project, but it does not
make that task less boring.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Let's consider this example</h2>
<div class="outline-text-2" id="text-1">
<blockquote>
<p>
You are working in a Java project. One of the thing to test is the validation
logic of some input XML files. One object, called the
XmlInputSuperbEnterpriseValidator (notice the Java naming convention), takes
a XML file path as input and return true if the file is valid.
</p>
</blockquote>

<p>
Input file is just a simple XML file, which could look like this:
</p>
zsh:1: command not found: pygmentize
<p>
where value1 accepts number between 0 and 9 and value2 accepts letters (a-z).
</p>

<p>
To test this, one can create a test class like the following.
</p>
zsh:1: command not found: pygmentize

<p>
Then, for each test case, create the XML file and add exactly the same test
function.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">When things go sideways</h2>
<div class="outline-text-2" id="text-2">
<p>
What if you have 50 different permutations of XML file. You'll need to create
all of them and create the exact same test methods. And what if the
specification change and you have to add new fields? Here again, a lot of
manual operation will be required to update the test cases.
</p>

<p>
What could happen here is that the tests will just be thrown away as the
maintenance is taking more effort that most people are willing to give.
</p>

<p>
As a good little software engineer, one of the question that should pop out
of your mind is: "Isn't there a better way to do that?"
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Of course there is a better way</h2>
<div class="outline-text-2" id="text-3">
<p>
It's not rocket science, but using python (or any other language really) to
automate the test creation will save you a bunch of time and also make
everybody in the project happier.
</p>

<p>
The basic workflow is the following:
</p>
<ol class="org-ol">
<li>Create test data definition: It could be just a simple text file that
describes the tests you want to run.
</li>
<li>Run the script to generate the data and the test class
</li>
<li>Run the tests and enjoy
</li>
</ol>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">Test definition</h3>
<div class="outline-text-3" id="text-3-1">
<p>
The test definition is the input of the generator. We need to specify what
kind of test data we want to generate. In this example, we want to generate
tests that will try all possible permutations for value1 and value2 of the
input file.
</p>

<p>
The format of the test definition is up to you; here we will just use plain
text.
</p>

<pre class="example">
1,2,3,4,5,6,7,8,9
a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z
</pre>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">Generating the test data and test class</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1">Representing our test data in Python</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
First things first, let's create a class that will represent the data for one
test:
</p>
zsh:1: command not found: pygmentize

<p>
We have our test data representation, great. Now we need a way to convert it
to text. We could just use Python string interpolation but there is a much
better way.
</p>
</div>
</div>

<div id="outline-container-sec-3-2-2" class="outline-4">
<h4 id="sec-3-2-2">Templating language, Yokoso</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
A very neat way to generate text file in python is to use a templating
language. Web frameworks, such as Django or Flask, are heavy users of templating
language to generate the HTML pages from data coming from the server.
</p>

<p>
Here, we will use <a href="http://jinja.pocoo.org/docs/2.10/">jinja2</a> to generate our XML and java files.
First, define the template using jinja templating language. Quick way is just
to define it as a string in the python file but it can also be read from file,
which is better practice when the templates are getting bigger and more numerous.
</p>

zsh:1: command not found: pygmentize

<p>
Notice the curly brackets? Jinja will replace what's inside by whatever objects
we pass. Object should have variables 'value1' and 'value2' to work.
</p>

<p>
The next snippet will print this template with a test case object.
</p>

zsh:1: command not found: pygmentize

<p>
We insert the test<sub>case</sub> variable in the template by passing it as a keyword argument
of the render method of jinja2.Template. This will print:
</p>

zsh:1: command not found: pygmentize

<p>
Creating the template for the java test class can be done in a similar fashion.
Here, we will leverage the for loop of jinja.
</p>

zsh:1: command not found: pygmentize

<p>
The variable to insert in the template is test<sub>cases</sub>. It should be an iterable as we use
it in the for loop. Here how to generate 1000 test cases with the java class to test them.
</p>

zsh:1: command not found: pygmentize

<p>
Instead of printing the rendered templates to the console, we will just write them to
a file.
</p>
</div>
</div>

<div id="outline-container-sec-3-2-3" class="outline-4">
<h4 id="sec-3-2-3">Glue everything together</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
We have a way to represent our tests, we have a way to print our tests to file, we just need
to have a way to read our test specification and convert it to a TestCase object.
</p>

<p>
Our input file first line is the value1, and the second line is the value2. To avoid cluttering
the blog post, I will assume the file is always correct and has as many elements in the first
line than in the second line.
</p>

zsh:1: command not found: pygmentize

<p>
Then you can combine these value the way you want to create your test cases.
</p>

<p>
Using zip:
</p>
zsh:1: command not found: pygmentize

<p>
zip will create a generator from many iterables. The ith element of a zip object is a tuple containing
the ith elements of each of the input iterables. For example,
</p>

zsh:1: command not found: pygmentize

<p>
Will print "1 - 2" and "3 - 4".
</p>

<p>
zip is combined with enumerate. Enumerate is also very simple. It takes an iterator. The ith element
of enumerate is (i, ith element of input iterator).
</p>

zsh:1: command not found: pygmentize
<p>
Will print "Index 0: a" and "Index 1: b". Notice that when combining zip with enumerate, you need
to add brackets when unpacking the values. Not using brackets would throw a ValueError (not enough
values to unpack (expected 3, got 2). The reason is that enumerate is sending a tuple of size two.
</p>

<p>
Another way to combine test cases is to use itertools.product. Product will yield all combinaisons
possible of multiple iterables.
</p>

zsh:1: command not found: pygmentize

<p>
will print:
1 - a
1 - b
1 - c
2 - a
2 - b
2 - c
</p>

<p>
You can use product to test all the possible combinaisons of your input values.
</p>

zsh:1: command not found: pygmentize

<p>
There is so much to say about generators, iterators.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Generalizing this approach</h2>
<div class="outline-text-2" id="text-4">
<p>
In this post, we learned about how to use python and jinja2 to automate test creation. Instead of
spending your precious time writing boilerplate code, you can just focus on what you want to test.
</p>

<p>
This is a simple example, the concept of automation is very powerful and helps tremendously in every
day life. Even if your activities do not imply coding, there must be some repetitive task that can
be automize. For example, sending the same mail to each mail address in an excel spreadsheet. This
can be automized (see pandas to read from excel file).
</p>

<p>
If you're interested in the subject, have a look at <a href="https://automatetheboringstuff.com/">automate the boring stuff with Python.</a>
</p>
</div>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/fantasy-novel-series-and-the-wait/" class="u-url">Fantasy novel series, and the Wait</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Snoozetime
                    </span></p>
            <p class="dateline">
            <a href="posts/fantasy-novel-series-and-the-wait/" rel="bookmark">
            <time class="published dt-published" datetime="2018-04-26T14:25:14+09:00" itemprop="datePublished" title="2018-04-26 14:25">2018-04-26 14:25</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/fantasy-novel-series-and-the-wait/#disqus_thread" data-disqus-identifier="cache/posts/fantasy-novel-series-and-the-wait.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <p>
I've always been an avid reader of long fantasy novel series. As a kid, I used
to read Lord of the ring, Harry Potter (does it count? Yes it does!) and
basically everything I could put my hand on.
</p>

<p>
More recently I've been a huge fan of the work of Brandon Sanderson. For those
who don't know, Sandersonis the epic fantasy writer. He builds entire world
in different series of books that are somewhat connected in the
grander scheme: <a href="https://brandonsanderson.com/">Sanderson website</a>
</p>

<p>
So yes, I really love epic Fantasy. But amazing book series come with a big
caveat: the Wait. As opposed to the Thrill while reading, the Wait is the
excruciable period from when I finish a book until the next one is released.
Let's take a few example: The Stormlight Archive by Sanderson is a novel
series which contains 3 books at the moment:
</p>
<ul class="org-ul">
<li>The Way of Kings, published August 31, 2010
</li>
<li>Words of Radiance, published March 4, 2014
</li>
<li>Oathbringer, published November 14, 2017
</li>
</ul>
<p>
I've been in a state of passive suffering for at least 7 years.
</p>

<p>
Another great series of novel is <i>The Kingkiller Chronicle</i> by Patrick
Rothfuss. Here, the last book has been published 7 years ago!
</p>

<p>
And also, Game of Thrones people?
</p>

<p>
To be clear, I am very grateful to the authors out there that are
publishing these fantastic books. But how to satisfy the Wait? I've found
two ways some far:
</p>
<ol class="org-ol">
<li>Read more novels. This has the benefit of making me forget a bit about
the previous book I read, but it might add more series to the wait list.
</li>
<li>Read novel series that have already ended. That way no more wait. Just a
feeling of emptiness at the end.
</li>
</ol>
</div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/creating-notes-for-different-project-with-orgmode-and-emacs/" class="u-url">Creating notes for different project with Orgmode and Emacs</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Snoozetime
                    </span></p>
            <p class="dateline">
            <a href="posts/creating-notes-for-different-project-with-orgmode-and-emacs/" rel="bookmark">
            <time class="published dt-published" datetime="2018-04-16T22:04:33+09:00" itemprop="datePublished" title="2018-04-16 22:04">2018-04-16 22:04</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/creating-notes-for-different-project-with-orgmode-and-emacs/#disqus_thread" data-disqus-identifier="cache/posts/creating-notes-for-different-project-with-orgmode-and-emacs.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <p>
I'm always amazed when I watch people mastering emacs. They can do everything
so much faster and with less keystrokes. However, if you have no experience with
elisp like me, extending emacs to do what I want seems like a daunting task.
</p>

<p>
As always, reading books and blogs about Emacs can help (ironic that I am writing about this isn't it),
but practice beats everything when it comes to learing a new programming language.
That's why, after doing 20 times the same operation, I decided to implement some shortcut in Elisp.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">What I am trying to achieve</h2>
<div class="outline-text-2" id="text-1">
<p>
I am working in multiple projects at a time, both in my professional and personal
life so I need to way to create notes quickly, and organize them so that I can
find them easily. I used to use Evernote for this but after switching everything
to Emacs I prefer using Orgmode.
</p>

<p>
My custom Emacs command will prompt me for a project and a note name, and will
create a file in the correctly directory that I can edit.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Let's dissect the problem a bit</h2>
<div class="outline-text-2" id="text-2">
<p>
Here I need a way to:
</p>
<ul class="org-ul">
<li>Find the list of my current projects
</li>
<li>Get a name for the new note
</li>
<li>Create the file name from above
</li>
<li>Create the note and switch to orgmode
</li>
</ul>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">How to test Elips easily</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Elisp is much easier when you can test commands one by one. There is a good tutorial <a href="https://learnxinyminutes.com/docs/elisp/">here</a> on lisp-interaction-mode.
This tutorial also links the great essay by Norvig about how to learn a programming language so I thought it was
appropriate to link it <a href="http://norvig.com/21-days.html">here</a> as well.
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Find all the projects</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Projects here are represented as subdirectory of the projects folder. Basically, the folders are structured as: ~/notes/projects/,
so notes for project 'example' would be stored under ~/notes/projects/example/.
</p>

<p>
Here comes the first function. It will fetch all the directories under the projects folder and ask the user to choose one.
</p>

zsh:1: command not found: pygmentize

<p>
Here, <i>directory-files</i> will list all the files in the given directory (one improvement would be to keep only folders).
Next line will prompt me for a choice in this list of file and will return my choice.
</p>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">Get a note name</h3>
<div class="outline-text-3" id="text-2-3">
<p>
To read a string from an user, read-string is the way to go.
</p>

zsh:1: command not found: pygmentize

<p>
This will open a mini-buffer and will display "Choose the note name: ". It will return the user's answer.
</p>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">Concatenate everything to get the note path</h3>
<div class="outline-text-3" id="text-2-4">
<p>
I played around a bit with clojure so I was expecting concatenating a list of strings to be as easy, but unfortunatly
it is slightly more complicated here. I am using the concatenate function that requires a type specifier.
</p>

zsh:1: command not found: pygmentize

<p>
In the next function, I am also using the let form which let (:')) me write cleaner code.
</p>

zsh:1: command not found: pygmentize

<p>
The hardcoded slashes are ugly and I pretty sure there is a better way to create the path from tokens
</p>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5">Create the note</h3>
<div class="outline-text-3" id="text-2-5">
<p>
You can use find-file to create a file and edit it in the current window. In my case, I want to open a new window to edit
the note so I am using find-file-other-window instead.
</p>

<p>
The function looks like:
</p>

zsh:1: command not found: pygmentize

<p>
Notice (interactive) which is there to make the function available when typing M-x. (org-mode) is also called after switching
buffer so that the correct mode is used for editing the note.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">It's done! But</h2>
<div class="outline-text-2" id="text-3">
<p>
There is a lot of things to improve:
</p>
<ul class="org-ul">
<li>I'd like to be able to create a new project if it does not exist instead of having to create a new folder myself.
</li>
<li>directory-files lists all files in a directory, including non-folders and ".", "..". These need to be filtered out.
</li>
<li>Concatenating is ugly.
</li>
<li>After creating a note, I am using yasnippet to set the note skeleton. There should be a way to automize that.
</li>
</ul>
<p>
That first experience with Elisp was anyway encouraging as I used this function everyday. Stay tuned for other code dissection ;)
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Full code</h2>
<div class="outline-text-2" id="text-4">
zsh:1: command not found: pygmentize
</div>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/kucoin-rest-api-reality-check/" class="u-url">Kucoin REST API, reality check</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Snoozetime
                    </span></p>
            <p class="dateline">
            <a href="posts/kucoin-rest-api-reality-check/" rel="bookmark">
            <time class="published dt-published" datetime="2018-04-05T18:06:41+09:00" itemprop="datePublished" title="2018-04-05 18:06">2018-04-05 18:06</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/kucoin-rest-api-reality-check/#disqus_thread" data-disqus-identifier="cache/posts/kucoin-rest-api-reality-check.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">My experience with kucoin REST API</h2>
<div class="outline-text-2" id="text-1">
<p>
I've been playing a bit with cryptocurrency recently and Kucoin exchange, with its numerous coins, seemed like a great
place to experiment.
</p>

<p>
However, as often in software, reality and expectations are not aligned. Let's forget about Kucoin limitation as an exchange
 (no market order?), what really hurt was the REST API quality.
</p>

<p>
Getting details of an order does not work: <a href="https://github.com/sammchardy/python-kucoin/issues/23">https://github.com/sammchardy/python-kucoin/issues/23</a> (Check out the answer from
the exchange support for extra fun). Then, when trying to cancel an order, I received a "System Error". It appeared that 
orders could not be canceled through the API for some time. 
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Morale of the story</h2>
<div class="outline-text-2" id="text-2">
<p>
It looks like I am bashing Kucoin here. I am not (well maybe a bit).  The whole crypto space is young and moving at
an extreme pace. Competition between exchanges is hard and it does not surprise me that not everything is working
as expected. 
</p>

<p>
As a developer, one should program defensively when dealing with external parties, even more when the external party 
cannot be trusted.
</p>
</div>
</div>
                </div>
            </article>
</div>
    

    
        
       <script>var disqus_shortname="https-snoozetime-github-io";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-SDRP1VVYu+tgAGKhddBSl5+ezofHKZeI+OzxakbIe/Y=" crossorigin="anonymous"></script><script type="text/x-mathjax-config">
        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']]}});
        </script><!--End of body content--><footer id="footer">
            Contents  2018         <a href="mailto:benoit.eudier@gmail.com">Snoozetime</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
